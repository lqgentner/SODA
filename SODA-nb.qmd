---
title: "Spain Occupational Accident Analysis (SODA)"
subtitle: "Business Analytics Project"
author: "Luis Gentner"
toc: true
date: today
format:
  html:
    embed-resources: true
editor: visual
---

```{r}
#| message: false
library(conflicted)
library(tidyverse)
library(scales)
library(ggrepel)
library(gghighlight)
library(mapSpain)
library(ESdata)

conflicts_prefer(
  dplyr::filter(),
  dplyr::select(),
  dplyr::lag(),
)
```

## Introduction

This report covers the analysis of occupational accidents, also known as work accidents, in Spain

## Data Exploration

### Work Accident Data

```{r}
load("data/ATR/ATR-I.1.3.RData")
atr |>
  filter(sector == "Total",
         ccaa == "ES") |>
  ggplot(aes(date, accidents)) +
  geom_line() +
  geom_point()
```

```{r}
atr |>
  filter(ccaa == "ES") |>
  ggplot(aes(x = date, y = accidents, color = sector)) +
  geom_line() +
  geom_point(size=2) +
    labs(x = "Year",
         y = "Work accidents per 100k workers",
         title = "Work accidents in Spain from 2009 to 2021")
```

### Add year over year change

```{r}
atr <- atr |>
  mutate(acc_yoy = (accidents - lag(accidents)) / lag(accidents),
         .by = c(sector, ccaa))
```

```{r}
atr |>
  filter(ccaa == "ES") |>
  drop_na() |>
  ggplot(aes(x = date, y = acc_yoy, color = sector)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray50") +
  geom_line() +
  geom_point() +
  scale_y_continuous(labels = label_percent()) +
  labs(x = "Year",
       y = "Year over year change",
       title = "Work accidents in Spain from 2009 to 2021")
```

```{r}
atr |>
  filter(ccaa == "ES") |>
  drop_na() |>
  ggplot(aes(x = date, y = acc_yoy, fill = sector)) +
  geom_col() +
  facet_wrap(~sector) +
  scale_y_continuous(labels = label_percent()) +
  labs(x = "Year",
       y = "Year over year change",
       title = "Work accidents in Spain from 2009 to 2021") +
  theme(legend.position = c(1, -0.5),
        legend.justification = c(1,  -0.5))
```

```{r}
atr |>
  filter(ccaa == "ES") |>
  ggplot(aes(x = date, y = accidents, color = sector)) +
  geom_line() +
  geom_point() +
  gghighlight(sector != "total", label_key = sector, use_group_by = FALSE) +
  facet_wrap(~sector)
```

Idea: Year over year change (per sector)

```{r}
atr |>
  filter(ccaa != "ES",
         sector == "Total",
         year == 2021) |>
  ggplot(aes(x = accidents, y = fct_reorder(ccaa_name, accidents))) +
  geom_col() +
  labs(x = "Work accidents per 100k workers",
       y = NULL,
       title = "Work accidents in 2021 per autonomous community")
```

### Active working population

```{r}
epa_sector |>
  filter(region == "ES",
         # periodo == "2020-09-30",
         edad == "total",
         sexo == "total")
```

\

```{r}
#| warning: false

ccaa <- esp_get_ccaa()
can_box <- esp_get_can_box()

atr_2021 <- atr |>
  filter(year == 2021,
         ccaa != "ES",
         sector == "Total") |>
  mutate(ccaa = as.character(ccaa))

ccaa_atr <- ccaa |>
  inner_join(atr_2021, by = join_by(iso2.ccaa.code == ccaa))

ggplot(ccaa_atr) +
  geom_sf(aes(fill = accidents),
          color = "grey70",
          linewidth = .3) +
  geom_sf(data = can_box, color = "grey70") +
  geom_label_repel(
    aes(label = round(accidents), geometry = geometry),
    stat = "sf_coordinates",
    fill = alpha(c("white"),0.5),
    color = "black",
    size = 3,
    label.size = 0
  ) +
  scale_fill_gradientn(
    colors = hcl.colors(10, "Blues", rev = TRUE),
    n.breaks = 10,
    guide = guide_legend(title = "Accidents per\n100k workers",
                         reverse = TRUE),
  ) +
  theme_void() +
  theme(legend.position = c(0.1, 0.6)) +
  labs(x = NULL, y = NULL,
       title = "Work accidents in 2021 per autonomous community")
```

```{r}
library(plotly)
library(sf)


ccaa <- esp_get_ccaa() |> sf::st_cast("MULTIPOLYGON")
ccaa_atr <- ccaa |>
  inner_join(atr_2021, by = join_by(iso2.ccaa.code == ccaa))

p <- ggplot(ccaa_atr, aes(label = ine.ccaa.name)) +
  geom_sf(aes(fill = accidents),
          color = "grey70",
          linewidth = .3) +
  scale_fill_gradientn(
    colors = hcl.colors(10, "Blues", rev = TRUE),
    n.breaks = 10,
    guide = guide_legend(title = "Accidents per\n100k workers",
                         reverse = TRUE),
  ) +
  theme_void() +
  theme(legend.position = c(0.1, 0.6)) +
  labs(x = NULL, y = NULL,
       title = "Work accidents in 2021 per autonomous community")

ggplotly(p)
```
